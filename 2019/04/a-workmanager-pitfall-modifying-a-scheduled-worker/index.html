<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>A WorkManager Pitfall: Modifying a Scheduled Worker | craigrussell</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="A WorkManager Pitfall: Modifying a Scheduled Worker" />
<meta name="author" content="Craig Russell" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A potential WorkManager pitfall when refactoring or deleting your Worker subclasses." />
<meta property="og:description" content="A potential WorkManager pitfall when refactoring or deleting your Worker subclasses." />
<link rel="canonical" href="https://cdrussell.github.io//2019/04/a-workmanager-pitfall-modifying-a-scheduled-worker/" />
<meta property="og:url" content="https://cdrussell.github.io//2019/04/a-workmanager-pitfall-modifying-a-scheduled-worker/" />
<meta property="og:site_name" content="craigrussell" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-23T23:59:50+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="A WorkManager Pitfall: Modifying a Scheduled Worker" />
<script type="application/ld+json">
{"description":"A potential WorkManager pitfall when refactoring or deleting your Worker subclasses.","url":"https://cdrussell.github.io//2019/04/a-workmanager-pitfall-modifying-a-scheduled-worker/","@type":"BlogPosting","headline":"A WorkManager Pitfall: Modifying a Scheduled Worker","dateModified":"2019-04-23T23:59:50+00:00","datePublished":"2019-04-23T23:59:50+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://cdrussell.github.io//2019/04/a-workmanager-pitfall-modifying-a-scheduled-worker/"},"author":{"@type":"Person","name":"Craig Russell"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header >
        <a href='https://cdrussell.github.io//'>
          <h1>craigrussell</h1>
          
            <p>Technical blog from Craig Russell.</p>
          
        </a>

        <nav>
  <div style="
         top: 0px;
         right: 0px;
         position: absolute">

    <a href="/about">
      <figure>
        <img src="/images/me-round.png"
             style="
              height: 50px;
              display: block;
              margin-left: auto;
              margin-right: auto;
              "
             alt="Photo of me, wearing a bright yellow t-shirt with a bright blue, cloudy sky in the background"
        />
        <figcaption style="text-align:justify" >About me</figcaption>
      </figure>
    </a>
  </div>
</nav>


        <p> </p>
      </header>
      <section>

      <p><em>This post describes a potential <code class="language-plaintext highlighter-rouge">WorkManager</code> pitfall when refactoring or deleting your <code class="language-plaintext highlighter-rouge">Worker</code> subclasses.</em></p>

<h2 id="overview">Overview</h2>
<p>When using <a href="https://developer.android.com/topic/libraries/architecture/workmanager/"><code class="language-plaintext highlighter-rouge">WorkManager</code></a>, you define a <code class="language-plaintext highlighter-rouge">Worker</code> subclass, optionally add some constraints and enqueue it with <code class="language-plaintext highlighter-rouge">WorkManager</code> so that your work will happen sometime later.</p>

<h3 id="how-bad-things-might-happen">How bad things might happen</h3>
<p>But what happens if:</p>

<ol>
  <li>you schedule a job for sometime in the future</li>
  <li>before the job runs, you update your app to rename, move or delete the <code class="language-plaintext highlighter-rouge">Worker</code> class?</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">WorkManager</code> will try to create the <code class="language-plaintext highlighter-rouge">Worker</code> you told it to use but will be unable to find that class.</p>

<h3 id="why-would-anyone-do-that">Why would anyone do that?</h3>
<p>Perhaps your worker was part of an experimental feature you were building, but later decided to pull. Perhaps you refactored a worker to have a different name and/or package.</p>

<h3 id="isnt-that-a-really-silly-thing-to-do">Isn’t that a really silly thing to do?</h3>
<p>Refactoring most code shouldn’t be dangerous and if you are never going to need a <code class="language-plaintext highlighter-rouge">Worker</code> again, there’s a downside to leaving unused code in your APK. So refactoring or removing a <code class="language-plaintext highlighter-rouge">Worker</code> isn’t a silly mistake; it might genuinely be something you need to do.</p>

<p>This is a scenario that might bite you. This post details what happens in this scenario and why, and offers particular advice for handling this situation when using a custom <code class="language-plaintext highlighter-rouge">WorkerFactory</code>.</p>

<h3 id="scheduling-work-to-happen">Scheduling work to happen</h3>
<p>You tell <code class="language-plaintext highlighter-rouge">WorkManager</code> which <code class="language-plaintext highlighter-rouge">Worker</code> should run as part of building the work request.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">val</span> <span class="py">workRequest</span> <span class="p">=</span> <span class="nc">OneTimeWorkRequestBuilder</span><span class="p">&lt;</span><span class="nc">MyWorker</span><span class="p">&gt;().</span><span class="nf">build</span><span class="p">()</span>
<span class="nc">WorkManager</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="nf">enqueue</span><span class="p">(</span><span class="n">workRequest</span><span class="p">)</span>

</code></pre></div></div>

<p>At the stage of enqueuing the work, an instance of your <code class="language-plaintext highlighter-rouge">Worker</code> <strong>is not yet</strong> created. It won’t be created until <code class="language-plaintext highlighter-rouge">WorkManager</code> decides your work should run.</p>

<h3 id="when-its-time-to-work">When it’s time to work</h3>
<p>When the time comes for your work to run, an instance of your <code class="language-plaintext highlighter-rouge">Worker</code> will be instantiated. By default, this will be done by <a href="https://developer.android.com/reference/androidx/work/WorkerFactory#createWorker(android.content.Context,%2520java.lang.String,%2520androidx.work.WorkerParameters)">WorkerFactory</a>.</p>

<p>The problem is that if you have removed the <code class="language-plaintext highlighter-rouge">Worker</code> subclass from your APK (or moved/renamed it), then the <code class="language-plaintext highlighter-rouge">WorkerFactory</code> will be handed the class name as it was when you scheduled the work, and asked to create a new instance of it. This will fail.</p>

<h3 id="example">Example</h3>
<p><strong>Monday</strong></p>

<ul>
  <li>You release v1 of your app.</li>
  <li>You have a worker called <code class="language-plaintext highlighter-rouge">com.foo.MyWorker</code></li>
  <li>You schedule work for that worker to happen in 2 days’ time</li>
</ul>

<p><strong>Tuesday</strong></p>

<ul>
  <li>You move <code class="language-plaintext highlighter-rouge">MyWorker</code> class to <code class="language-plaintext highlighter-rouge">com.bar.MyWorker</code></li>
  <li>You release v2 of your app</li>
</ul>

<p><strong>Wednesday</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">WorkManager</code> will try to create an instance of <code class="language-plaintext highlighter-rouge">com.foo.MyWorker</code> which doesn’t exist.</li>
</ul>

<p>Another scenario is if instead of moving <code class="language-plaintext highlighter-rouge">com.foo.MyWorker</code>, you delete it altogether.</p>

<p>In this case, you might be surprised to see <code class="language-plaintext highlighter-rouge">WorkManager</code> still attempting to create an instance of <code class="language-plaintext highlighter-rouge">com.foo.MyWorker</code>.</p>

<h4 id="what-will-happen">What will happen?</h4>
<p>Your job won’t run as expected. How major a bug that is will depend on your app and what the job was supposed to do.</p>

<p>As well as not running, there might be another consequence: the app might crash. The default <code class="language-plaintext highlighter-rouge">WorkerFactory</code> will handle this scenario safely enough to not crash, but the job still won’t run.</p>

<p>If you are using a custom <code class="language-plaintext highlighter-rouge">WorkerFactory</code>, then you will have to ensure you are creating <code class="language-plaintext highlighter-rouge">Worker</code> instances in a safe way that is resilient to these types of changes.</p>

<h3 id="custom-workerfactory">Custom WorkerFactory</h3>
<p>In some use cases you might find yourself registering a <a href="https://stackoverflow.com/a/53377279/1654145">custom <code class="language-plaintext highlighter-rouge">WorkerFactory</code> implementation</a>. This is particularly useful if you want to use <code class="language-plaintext highlighter-rouge">Dagger</code> to inject objects into your <code class="language-plaintext highlighter-rouge">Worker</code> subclass.</p>

<h4 id="naive-implementation-of-customworkerfactory">Naive Implementation of CustomWorkerFactory</h4>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="err">⚠️</span> <span class="nc">This</span> <span class="n">implementations</span> <span class="n">has</span> <span class="n">flaws</span> <span class="err">⚠️</span>

<span class="kd">class</span> <span class="nc">CustomWorkerFactory</span> <span class="p">:</span> <span class="nc">WorkerFactory</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createWorker</span><span class="p">(</span><span class="n">appContext</span><span class="p">:</span> <span class="nc">Context</span><span class="p">,</span> <span class="n">workerClassName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">workerParameters</span><span class="p">:</span> <span class="nc">WorkerParameters</span><span class="p">):</span> <span class="nc">ListenableWorker</span><span class="p">?</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">workerClass</span> <span class="p">=</span> <span class="nc">Class</span><span class="p">.</span><span class="nf">forName</span><span class="p">(</span><span class="n">workerClassName</span><span class="p">).</span><span class="nf">asSubclass</span><span class="p">(</span><span class="nc">ListenableWorker</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">constructor</span> <span class="p">=</span> <span class="n">workerClass</span><span class="p">.</span><span class="nf">getDeclaredConstructor</span><span class="p">(</span><span class="nc">Context</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="nc">WorkerParameters</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">constructor</span><span class="p">.</span><span class="nf">newInstance</span><span class="p">(</span><span class="n">appContext</span><span class="p">,</span> <span class="n">workerParameters</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<p>What’s the problem here? As in the above example, if you originally enqueued a work request using <code class="language-plaintext highlighter-rouge">com.foo.MyWorker</code> then that will be passed into the <code class="language-plaintext highlighter-rouge">createWorker()</code> function as the <code class="language-plaintext highlighter-rouge">workerClassName: String</code> parameter.</p>

<p>In the naive implementation above, <code class="language-plaintext highlighter-rouge">com.foo.MyWorker</code> no longer exists, and attempts to find the class for it will result in a <code class="language-plaintext highlighter-rouge">ClassNotFoundException</code> being thrown.</p>

<h4 id="safer-implementation-of-customworkerfactory">Safer Implementation of CustomWorkerFactory</h4>
<p>We need to wrap the attempts at finding the class in a <code class="language-plaintext highlighter-rouge">try/catch</code> block, ensuring we catch <code class="language-plaintext highlighter-rouge">ClassNotFoundException</code> since we now know how and why that might happen.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomWorkerFactory</span> <span class="p">:</span> <span class="nc">WorkerFactory</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createWorker</span><span class="p">(</span><span class="n">appContext</span><span class="p">:</span> <span class="nc">Context</span><span class="p">,</span> <span class="n">workerClassName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">workerParameters</span><span class="p">:</span> <span class="nc">WorkerParameters</span><span class="p">):</span> <span class="nc">ListenableWorker</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">workerClass</span> <span class="p">=</span> <span class="nc">Class</span><span class="p">.</span><span class="nf">forName</span><span class="p">(</span><span class="n">workerClassName</span><span class="p">).</span><span class="nf">asSubclass</span><span class="p">(</span><span class="nc">ListenableWorker</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">constructor</span> <span class="p">=</span> <span class="n">workerClass</span><span class="p">.</span><span class="nf">getDeclaredConstructor</span><span class="p">(</span><span class="nc">Context</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="nc">WorkerParameters</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">constructor</span><span class="p">.</span><span class="nf">newInstance</span><span class="p">(</span><span class="n">appContext</span><span class="p">,</span> <span class="n">workerParameters</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">ClassNotFoundException</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">null</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<p>After catching the <code class="language-plaintext highlighter-rouge">ClassNotFoundException</code>, we return <code class="language-plaintext highlighter-rouge">null</code>.</p>

<p>As per the documentation, you should return <code class="language-plaintext highlighter-rouge">null</code> if the worker could not be created.</p>


<a href='https://cdrussell.github.io//'>Home</a>


      </section>
    </div>
    <footer>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
  </body>
</html>
