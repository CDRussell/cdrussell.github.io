<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Shooting Yourself in the Foot While Adding an Element to a Kotlin List | craigrussell</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Shooting Yourself in the Foot While Adding an Element to a Kotlin List" />
<meta name="author" content="Craig Russell" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The functions add() and plus() which are available on some Kotlin collections, and how despite their similar looking names, their underlying implementations can make a big difference." />
<meta property="og:description" content="The functions add() and plus() which are available on some Kotlin collections, and how despite their similar looking names, their underlying implementations can make a big difference." />
<link rel="canonical" href="https://cdrussell.github.io//2019/03/shooting-yourself-in-the-foot-while-adding-an-element-to-a-kotlin-list/" />
<meta property="og:url" content="https://cdrussell.github.io//2019/03/shooting-yourself-in-the-foot-while-adding-an-element-to-a-kotlin-list/" />
<meta property="og:site_name" content="craigrussell" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-02T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Shooting Yourself in the Foot While Adding an Element to a Kotlin List" />
<script type="application/ld+json">
{"description":"The functions add() and plus() which are available on some Kotlin collections, and how despite their similar looking names, their underlying implementations can make a big difference.","url":"https://cdrussell.github.io//2019/03/shooting-yourself-in-the-foot-while-adding-an-element-to-a-kotlin-list/","@type":"BlogPosting","headline":"Shooting Yourself in the Foot While Adding an Element to a Kotlin List","dateModified":"2019-03-02T00:00:00+00:00","datePublished":"2019-03-02T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://cdrussell.github.io//2019/03/shooting-yourself-in-the-foot-while-adding-an-element-to-a-kotlin-list/"},"author":{"@type":"Person","name":"Craig Russell"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header >
        <a href='https://cdrussell.github.io//'>
          <h1>craigrussell</h1>
          
            <p>Technical blog from Craig Russell.</p>
          
        </a>

        <nav>
  <div style="
         top: 0px;
         right: 0px;
         position: absolute">

    <a href="/about">
      <figure>
        <img src="/images/me-round.png"
             style="
              height: 50px;
              display: block;
              margin-left: auto;
              margin-right: auto;
              "
             alt="Photo of me, wearing a bright yellow t-shirt with a bright blue, cloudy sky in the background"
        />
        <figcaption style="text-align:justify" >About me</figcaption>
      </figure>
    </a>
  </div>
</nav>


        <p>¬†</p>
      </header>
      <section>

      <p><em>This post discusses the functions <code class="language-plaintext highlighter-rouge">add()</code> and <code class="language-plaintext highlighter-rouge">plus()</code> which are available on some Kotlin collections, and how despite their similar looking names, their underlying implementations can make a big difference</em></p>

<h2 id="a-primer-on-operator-overloads">A primer on operator overloads</h2>

<p>Kotlin supports <a href="https://kotlinlang.org/docs/reference/operator-overloading.html">Operator Overloading</a>, which means you can make use of operators like <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">+=</code> as a shorthand for calling otherwise normal functions. However, it‚Äôs always worth checking what the underlying function actually does as otherwise you might catch yourself out.</p>

<p>For example, to add an <code class="language-plaintext highlighter-rouge">Int</code> to a collection, there are a few options available, and you‚Äôd be forgiven for thinking they are all syntactic sugar for the same functionality.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">list</span> <span class="p">+</span> <span class="mi">3</span> 
<span class="n">list</span><span class="p">.</span><span class="nf">plus</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">3</span>
<span class="n">list</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 

<span class="c1">// note, depending on the collection type, some of these will compile and some won't</span>

</code></pre></div></div>

<p>Consider the following code:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">val</span> <span class="py">foo</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
<span class="n">foo</span> <span class="p">+</span> <span class="mi">1</span>
<span class="n">foo</span> <span class="p">+</span> <span class="mi">2</span>
<span class="nf">printlist</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>

</code></pre></div></div>

<p>You might expect this to result in a list which contains 2 items <code class="language-plaintext highlighter-rouge">[1, 2]</code>.</p>

<p>Except it won‚Äôt. You‚Äôll be left with an empty list.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// OUTPUT
0 items in list: []
</code></pre></div></div>

<p>To see why, we can explore the function that is invoked when you use the overloaded <code class="language-plaintext highlighter-rouge">+</code> operator on a <code class="language-plaintext highlighter-rouge">List</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
 * Returns a list containing all elements of the original collection and then the given [element].
 */</span>
<span class="k">public</span> <span class="k">operator</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">Collection</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;.</span><span class="nf">plus</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">T</span><span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span><span class="n">size</span> <span class="p">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="n">result</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>Note the signature of this function: it has <code class="language-plaintext highlighter-rouge">operator</code> in the signature and is called <code class="language-plaintext highlighter-rouge">plus</code> - this is why it is invoked when you call <code class="language-plaintext highlighter-rouge">foo + 1</code>.</p>

<p>What does this function do?</p>

<ol>
  <li>creates a new list</li>
  <li>adds all elements from the original list to it</li>
  <li>adds the new element to it</li>
  <li>returns the new list.</li>
</ol>

<p>Here‚Äôs the important thing to remember: <strong>it doesn‚Äôt modify the original list</strong>. So this now explains why, in our original example, we were left looking at an empty list. When we call <code class="language-plaintext highlighter-rouge">foo + 1</code> we are given a new list back that we ignore. We call <code class="language-plaintext highlighter-rouge">foo + 2</code> and are given another new list back, which we ignore again.</p>

<p>To fix this, we need to stop ignoring the returned list. One way we can do that is to reassign the original list var to the new list which is returned each time (note because we are reassigning the variable, we need to switch from <code class="language-plaintext highlighter-rouge">val</code> to <code class="language-plaintext highlighter-rouge">var</code>):</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="py">foo</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
<span class="n">foo</span> <span class="p">=</span> <span class="n">foo</span> <span class="p">+</span> <span class="mi">1</span>
<span class="n">foo</span> <span class="p">=</span> <span class="n">foo</span> <span class="p">+</span> <span class="mi">2</span>
<span class="nf">printlist</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">foo = foo + 1</code> can be condensed, using another overloaded operator <code class="language-plaintext highlighter-rouge">+=</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="py">foo</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
<span class="n">foo</span> <span class="p">+=</span> <span class="mi">1</span>
<span class="n">foo</span> <span class="p">+=</span> <span class="mi">2</span>
<span class="nf">printlist</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// OUTPUT
2 items in list: [1, 2]
</code></pre></div></div>

<h2 id="where-it-gets-confusing">Where it gets confusing</h2>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">val</span> <span class="py">foo</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
<span class="n">foo</span><span class="p">.</span><span class="nf">plus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">foo</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">printlist</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>

</code></pre></div></div>

<p>What we‚Äôre left with, in some collections, is the ability to choose between two <em>very similar</em> looking methods which do different things.</p>

<p>We now know calling the <code class="language-plaintext highlighter-rouge">.plus()</code> function is equivalent to calling <code class="language-plaintext highlighter-rouge">+</code>, and therefore will have the behaviour of returning a brand new list.</p>

<p>What about the <code class="language-plaintext highlighter-rouge">.add()</code> function?</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
* Appends the specified element to the end of this list.
*
* @param e element to be appended to this list
* @return &lt;tt&gt;true&lt;/tt&gt; (as specified by {@link Collection#add})
*/</span>
<span class="k">public</span> <span class="n">boolean</span> <span class="nf">add</span><span class="p">(</span><span class="nc">E</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">ensureCapacityInternal</span><span class="p">(</span><span class="n">size</span> <span class="p">+</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">// Increments modCount!!</span>
  <span class="n">elementData</span><span class="p">[</span><span class="n">size</span><span class="p">++]</span> <span class="p">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>From the source, we can see that <code class="language-plaintext highlighter-rouge">.add()</code> does not return a new list and <strong>it does modify the original list</strong>.</p>

<p>My brain sees <code class="language-plaintext highlighter-rouge">plus</code> and <code class="language-plaintext highlighter-rouge">add</code> as being almost entirely synonymous and yet their behaviour is entirely different. üò∞</p>

<h2 id="further-confusion">Further confusion</h2>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// this doesn't compile</span>
<span class="kd">var</span> <span class="py">list</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">1</span>

<span class="c1">// this doesn't compile</span>
<span class="kd">var</span> <span class="py">list</span><span class="p">:</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">()</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">1</span>

<span class="c1">// this compiles ü§®</span>
<span class="kd">var</span> <span class="py">list</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">()</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">1</span>

</code></pre></div></div>

<p>In the first two examples above, we see a compilation error where we try to add to the list using <code class="language-plaintext highlighter-rouge">+=</code> operator; <code class="language-plaintext highlighter-rouge">Assignment operators ambiguity</code>. So the implementation matters less here than the declared type (which isn‚Äôt surprising, per se); depending on the declared type you‚Äôll possibly have multiple places where <code class="language-plaintext highlighter-rouge">+=</code> could work, and therefore the compiler doesn‚Äôt know which function you would actually want invoked.</p>

<p>In the third example, this compiles OK as there is only function could be invoked for <code class="language-plaintext highlighter-rouge">+=</code> usage.</p>

<h2 id="even-more-confusion">Even more confusion</h2>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// option 1</span>
<span class="kd">var</span> <span class="py">list</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">()</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">1</span>

<span class="c1">// option 2</span>
<span class="kd">var</span> <span class="py">list</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">mutableListOf</span><span class="p">()</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">1</span>

<span class="c1">// option 3</span>
<span class="kd">val</span> <span class="py">list</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
<span class="n">list</span> <span class="p">+=</span> <span class="mi">1</span>

</code></pre></div></div>

<p>Under the hood, in each case above we are dealing with <code class="language-plaintext highlighter-rouge">ArrayList</code>s. But the bevavior of <code class="language-plaintext highlighter-rouge">+=</code> is different.</p>

<ol>
  <li>Calling <code class="language-plaintext highlighter-rouge">+=</code> copies the whole list into a new list</li>
  <li>Calling <code class="language-plaintext highlighter-rouge">+=</code> copies the whole list into a new list</li>
  <li>Calling <code class="language-plaintext highlighter-rouge">+=</code> adds the element to existing list</li>
</ol>

<p>Why? As above, the type you‚Äôve declared the list as (rather than the implementation itself) is the determining factor in what <code class="language-plaintext highlighter-rouge">+=</code> will actually do when you use it.</p>

<p>When the declared type is a <code class="language-plaintext highlighter-rouge">List</code>, then calling <code class="language-plaintext highlighter-rouge">+=</code> will result in creating a brand new list and copying the old one into it. This is because a <code class="language-plaintext highlighter-rouge">List</code> type doesn‚Äôt indicate it is mutable. Whereas if you explicitly have a <code class="language-plaintext highlighter-rouge">MutableList</code> then <code class="language-plaintext highlighter-rouge">+=</code> can do the more performant adding of the item without creating a whole new list.</p>

<h2 id="so-plus-or-add---which-to-choose">So, plus() or add() - which to choose</h2>
<p>There‚Äôs probably not a single answer here; which is best will depend on your use case. For some collection types, there won‚Äôt even be an option. For other collections, like <code class="language-plaintext highlighter-rouge">ArrayList</code>, you‚Äôll be able to choose either approach.</p>

<p>There are times when ensuring your original list is not mutated is beneficial, and conversely there are times when performance concerns might mean you don‚Äôt want to create a new copy of the list each time you add to it.</p>

<p>I will say that I think <code class="language-plaintext highlighter-rouge">.add()</code> is going to outperfom <code class="language-plaintext highlighter-rouge">.plus()</code> in most, if not all, cases; it‚Äôs cheaper to expand an <code class="language-plaintext highlighter-rouge">ArrayList</code> than it is to copy the whole list and add a new entry to it.</p>

<h3 id="crude-performance-test">Crude performance test</h3>
<p>For consideration, I was curious how both the <code class="language-plaintext highlighter-rouge">.add()</code> and <code class="language-plaintext highlighter-rouge">.plus()</code> methods would perform on a large-ish list of <code class="language-plaintext highlighter-rouge">Integers</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">itemsToAdd</span> <span class="p">=</span> <span class="mi">500_000</span>

<span class="kd">val</span> <span class="py">tMutableList</span> <span class="p">=</span> <span class="nf">measureNanoTime</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">list</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">itemsToAdd</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">list</span> <span class="p">+=</span> <span class="n">i</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nc">Timber</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"Using += on `MutableList&lt;Int&gt;` took ${TimeUnit.NANOSECONDS.toMillis(tMutableList)}ms"</span><span class="p">)</span>


<span class="kd">val</span> <span class="py">t</span> <span class="p">=</span> <span class="nf">measureNanoTime</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">list</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">mutableListOf</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">itemsToAdd</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">list</span> <span class="p">+=</span> <span class="n">i</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nc">Timber</span><span class="p">.</span><span class="nf">i</span><span class="p">(</span><span class="s">"Using += on `List&lt;Int&gt;` took ${TimeUnit.NANOSECONDS.toMillis(t)}ms"</span><span class="p">)</span>
</code></pre></div></div>

<p>Want to take a guess how long each took? ‚è≤Ô∏è</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using += on `MutableList&lt;Int&gt;` took 74ms
Using += on `List&lt;Int&gt;` took 405,390ms (over 6 mins!!)
</code></pre></div></div>

<h2 id="round-up">Round up</h2>
<p>Despite the similiarities when you‚Äôre speaking English, there are important differences when you‚Äôre speaking Kotlin.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="n">list</span> <span class="p">+</span> <span class="mi">3</span> <span class="c1">// you've ignored the new list; here be dragons ‚ö†Ô∏èüêâ</span>
    <span class="n">list</span><span class="p">.</span><span class="nf">plus</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">// nope! same as above</span>
    <span class="n">list</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">// modifies `list`; resizes and inserts new entry</span>
    <span class="n">list</span> <span class="p">+=</span> <span class="mi">3</span> <span class="c1">// ü§∑‚Äç‚ôÇÔ∏è it depends on the declared type of the list</span>

</code></pre></div></div>

<h2 id="lessons">Lessons</h2>
<ul>
  <li>Never use a overloaded operator without ensuring you understand the function it will invoke</li>
  <li>The declared type of the variable matters in determining which function will be invoked (the actual implementation is less important)</li>
  <li>It‚Äôs easy to shoot yourself in the foot. üë¢üî´</li>
</ul>

<h2 id="thanks">Thanks</h2>
<p><em>The subtle differences described above were unknown to me until my teammate sent a PR my way which changed from using <code class="language-plaintext highlighter-rouge">+=</code> to using <code class="language-plaintext highlighter-rouge">.add()</code>. So thanks, <strong>Mia Alexiou</strong>, for teaching me something new today and for a making a tiny change which is likely to result in a good performance boost for our users.</em> üëè</p>

<p><em>Also, after I posted this article it raised quite a few discussions with different people. So thanks for everyone who discussed it with me, and in particular, thanks to <strong>Carmen Alvarez</strong> and <strong>Said Tahsin Dane</strong> (<a href="https://twitter.com/tasomaniac">@tasomaniac</a>) for pushing my understanding of these nuanaces further.</em></p>


<a href='https://cdrussell.github.io//'>Home</a>


      </section>
    </div>
    <footer>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
  </body>
</html>
